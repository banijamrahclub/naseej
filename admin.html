<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>إدارة الحجوزات - نِسيج</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Cairo',sans-serif;background:#0f2027;color:#fff;padding:18px}
    .card{background:rgba(255,255,255,0.03);padding:14px;border-radius:10px;margin-bottom:12px}
    .row{display:flex;gap:12px}
    input,button,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:right;border-bottom:1px solid rgba(255,255,255,0.03)}
    .danger{background:#ff6b6b;color:#fff}

    /* جدول زمني أسبوعي أكبر */
    .timetable{overflow:auto}
    .timetable-table{width:100%;border-collapse:collapse;font-size:0.92rem}
    .timetable-table th, .timetable-table td{border:1px solid rgba(255,255,255,0.03);padding:8px;vertical-align:middle;text-align:center}
    .timetable-table th.time-head, .timetable-table td.time{background:rgba(255,255,255,0.02);width:98px;font-weight:700}
    .timetable-table td.booked-cell{background:rgba(255,90,102,0.12);color:#b22a3b;cursor:pointer}
    .timetable-table td.free-cell{background:rgba(255,255,255,0.015);cursor:pointer}
    .timetable-table td.empty{opacity:0.6;color:#cfcfcf}
    @media (max-width:1100px){
      .timetable{overflow-x:auto}
      .timetable-table{font-size:0.95rem}
    }
    @media (max-width:900px){
      .timetable-table th, .timetable-table td{padding:6px;font-size:0.84rem}
      /* Make tables horizontally scrollable on smaller screens */
      #bookingsTable, .timetable-table{display:block; width:100%; overflow-x:auto}
      .timetable-table th, .timetable-table td{white-space:nowrap}
      /* Stack top controls */
      .card > div:first-child{flex-direction:column;align-items:stretch}
      .card > div:first-child label, .card > div:first-child button{width:100%;margin-bottom:8px}
      /* Make inputs and buttons full-width on small screens */
      input, select, button{width:100%;box-sizing:border-box}
      /* Modal responsive */
      #detailModal > div{margin:6% 8px; max-width:calc(100% - 16px);}
      /* Timetable smaller spacing */
      .timetable-table th.time-head, .timetable-table td.time{width:78px}
    }
    @media (max-width:420px){
      .timetable-table th.time-head, .timetable-table td.time{width:60px}
      .timetable-table th, .timetable-table td{padding:5px;font-size:0.8rem}
      .duration-btn, #mAdd{width:100%}
    }
  </style>
</head>
<body>
  <h2>لوحة إدارة الحجوزات</h2>
  <div class="card" id="loginCard">
    <label>كلمة المرور:</label>
    <div style="display:flex;gap:8px;margin-top:8px">
      <input type="password" id="adminPwd" placeholder="كلمة المرور" />
      <button id="loginBtn">تسجيل دخول</button>
    </div>
    <div id="loginMsg" style="margin-top:8px;color:#ffd700"></div>
  </div>

  <div class="card" id="adminUI" style="display:none">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <label>من: <input type="date" id="fromDate" /></label>
        <label>إلى: <input type="date" id="toDate" /></label>
        <button id="loadBtn">تحميل</button>
      </div>
      <div>
        <button id="logoutBtn">تسجيل خروج</button>
      </div>
    </div>

    <h3 style="margin-top:12px">الجدول الأسبوعي</h3>
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px;flex-wrap:wrap">
      <button id="weekPrev">‹ الأسبوع السابق</button>
      <div id="weekLabel" style="font-weight:700;min-width:180px;text-align:center">الأسبوع الحالي</div>
      <button id="weekNext">الأسبوع التالي ›</button>
      <button id="weekToday">اليوم</button>
      <button id="weekLoad">عرض الأسبوع</button>
      <input type="hidden" id="weekStart" />
    </div>
    <div class="card" id="weekView" style="min-height:320px;padding:10px">
      <div class="timetable" id="timetable">اختر بداية الأسبوع واضغط عرض لعرض جدول أسبوعي أكبر</div>
    </div>

    <h3 style="margin-top:12px">جدول الحجوزات</h3>
    <table id="bookingsTable"><thead><tr><th>الاسم</th><th>الهاتف</th><th>التاريخ</th><th>الوقت</th><th>المدة</th><th>السعر</th><th></th></tr></thead><tbody></tbody></table>

    <h3 style="margin-top:12px">أضف حجز يدوي</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
      <input id="mName" placeholder="الاسم" />
      <select id="mCountry" style="min-width:110px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff">
        <option value="+973" selected>+973 البحرين</option>
        <option value="+964">+964 العراق</option>
        <option value="+966">+966 السعودية</option>
        <option value="+971">+971 الإمارات</option>
        <option value="+962">+962 الأردن</option>
        <option value="+965">+965 الكويت</option>
        <option value="+963">+963 سوريا</option>
      </select>
      <input id="mPhone" placeholder="الهاتف" />
      <input id="mDate" type="date" />
      <input id="mTime" type="time" />
      <select id="mDur"><option value="60">60</option><option value="90">90</option><option value="120">120</option></select>
      <input id="mPrice" placeholder="السعر" />
      <button id="mAdd">أضف</button>
    </div>
    <div style="margin-top:8px"><button id="clearAll" style="background:#e63946;color:#fff;padding:6px 10px;border-radius:6px;border:none">حذف جميع الحجوزات</button></div>



    <!-- نافذة تفاصيل الحجز -->
    <div id="detailModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;">
      <div style="max-width:520px;margin:6% auto;background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;color:#fff;">
        <h3>تفاصيل الحجز</h3>
        <div id="modalContent" style="margin-top:8px"></div>
        <div style="text-align:left;margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
          <button id="modalCancel" class="danger">إلغاء الحجز</button>
          <button id="modalClose">إغلاق</button>
        </div>
      </div>
    </div>

    <!-- نافذة إضافة الحجز المنبثقة -->
    <div id="addModal" style="display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:9999;">
      <div style="max-width:520px;margin:6% auto;background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;color:#fff;">
        <h3>أضف حجز يدوي</h3>
        <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
          <input id="addName" placeholder="الاسم" />
          <select id="addCountry" style="min-width:110px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:#fff">
            <option value="+973" selected>+973 البحرين</option>
            <option value="+964">+964 العراق</option>
            <option value="+966">+966 السعودية</option>
            <option value="+971">+971 الإمارات</option>
            <option value="+962">+962 الأردن</option>
            <option value="+965">+965 الكويت</option>
            <option value="+963">+963 سوريا</option>
          </select>
          <input id="addPhone" placeholder="الهاتف" />
          <input id="addDate" type="date" />
          <input id="addTime" type="time" />
          <select id="addDur"><option value="60">60</option><option value="90">90</option><option value="120">120</option></select>
          <input id="addPrice" placeholder="السعر" />
        </div>
        <div style="text-align:left;margin-top:12px;display:flex;gap:8px;justify-content:flex-end;">
          <button id="addClose">إغلاق</button>
          <button id="addSave">أضف</button>
        </div>
      </div>
    </div>

    <h3 style="margin-top:12px">تغيير كلمة المرور</h3>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="oldPwd" placeholder="كلمة المرور القديمة" type="password" />
      <input id="newPwd" placeholder="كلمة المرور الجديدة" type="password" />
      <button id="chgPwd">تغيير</button>
    </div>

    <h3 style="margin-top:12px">العروض الخاصة</h3>
    <div style="margin-top:8px;padding:8px;border-radius:8px;background:linear-gradient(90deg,#e63946,#ffbaba);color:#fff;font-weight:700;text-align:center">العرض الخاص: ساعة ونصف بسعر 10 د، ساعتان بسعر 15 د</div>

  </div> 

  <script>
    async function postJson(url, body){ const r = await fetch(url, {method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body), credentials: 'same-origin'}); return r.json(); }

    // Helpers: compute week start (Monday) and auto-load current week
    function getWeekStartFor(d){ const dt = new Date(d); const day = dt.getDay(); // 0 Sun .. 6 Sat
      // shift so Monday = start of week
      const diff = (day === 0) ? -6 : (1 - day);
      dt.setDate(dt.getDate() + diff);
      return dt.toISOString().split('T')[0];
    }

    function setCurrentWeekAndLoad(){
      const ws = getWeekStartFor(new Date());
      const el = document.getElementById('weekStart');
      const label = document.getElementById('weekLabel');
      if(el.value !== ws){ el.value = ws; document.getElementById('weekLoad').click(); }
      if(label) label.textContent = 'الأسبوع من ' + ws;
    }

    function startWeekWatcher(){
      if(window._weekWatcher) return;
      window._weekWatcher = setInterval(()=>{
        const ws = getWeekStartFor(new Date());
        const el = document.getElementById('weekStart');
        if(el && el.value !== ws){ el.value = ws; document.getElementById('weekLoad').click(); /* optional: small visual hint */ }
      }, 60*1000); // check every minute
    }

    document.getElementById('loginBtn').onclick = async ()=>{
      const pwd = document.getElementById('adminPwd').value;
      const res = await postJson('/api/admin/login',{password:pwd});
      if(res.ok){
        document.getElementById('loginCard').style.display='none';
        document.getElementById('adminUI').style.display='block';
        loadBookings();
        // auto-set to this week's start and load it
        setCurrentWeekAndLoad();
        startWeekWatcher();
      } else { document.getElementById('loginMsg').textContent='كلمة مرور خاطئة'; }
    }

    document.getElementById('logoutBtn').onclick = async ()=>{ if(window.eventS && window.eventS.close) window.eventS.close(); await postJson('/api/admin/logout',{}); location.reload(); }

    async function loadBookings(){
      const from = document.getElementById('fromDate').value || '';
      const to = document.getElementById('toDate').value || '';
      const q = (from && to) ? `?from=${from}&to=${to}` : '';
      const res = await fetch('/api/bookings' + q);
      if(res.status===401){ alert('غير مصرح'); return; }
      const rows = await res.json();
      const tbody = document.querySelector('#bookingsTable tbody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${r.phone}</td><td>${r.date}</td><td>${r.time}</td><td>${r.duration}</td><td>${r.price}</td><td><button data-id="${r.id}" class="del">حذف</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.del').forEach(b=>b.onclick = async ()=>{ const id=b.dataset.id; await fetch('/api/bookings/'+id,{method:'DELETE', credentials: 'same-origin'}); loadBookings(); });
    }

    document.getElementById('loadBtn').onclick = loadBookings;

    const staticPromos = { '60':10, '90':10, '120':15 };
    const mDurEl = document.getElementById('mDur');
    const mPriceEl = document.getElementById('mPrice');
    mDurEl.onchange = function(){ mPriceEl.value = staticPromos[this.value] || ''; };
    // set initial suggested price
    mPriceEl.value = staticPromos[mDurEl.value] || '';

    document.getElementById('mAdd').onclick = async ()=>{
      const name=document.getElementById('mName').value;
      const cc = document.getElementById('mCountry').value || '+973';
      let phoneRaw=document.getElementById('mPhone').value.trim();
      let digits = phoneRaw.replace(/\D/g,'');
      if(!digits) return alert('ادخل رقم هاتف صحيح');
      let phone = digits.startsWith('0') ? cc + digits.replace(/^0+/, '') : (digits.startsWith('+') ? digits : cc + digits);
      const date=document.getElementById('mDate').value; const time=document.getElementById('mTime').value;
      const duration=document.getElementById('mDur').value; const price=document.getElementById('mPrice').value||0;
      const res = await postJson('/api/bookings',{name,phone,date,time,duration,price});
      if(res.error) alert('فشل: '+res.error); else { alert('تم الإضافة'); loadBookings(); }
    }

    // عرض جدول الأسبوع - يطلب الحجوزات من السيرفر ويعرضها خلف شبكية بسيطة
    document.getElementById('weekLoad').onclick = async ()=>{
      const start=document.getElementById('weekStart').value;
      if(!start) return alert('اختر بداية الأسبوع');
      const from = start;
      const d = new Date(start); d.setDate(d.getDate()+6);
      const to = d.toISOString().split('T')[0];
      const res = await fetch(`/api/bookings?from=${from}&to=${to}`, { credentials: 'same-origin' });
      if(res.status===401){ alert('غير مصرح'); return; }
      const rows = await res.json();
      renderWeekView(from, rows);
    }

    document.getElementById('weekToday').onclick = ()=>{
      // set to start of current week instead of raw today
      document.getElementById('weekStart').value = getWeekStartFor(new Date());
      document.getElementById('weekLoad').click();
    }

    document.getElementById('weekPrev').onclick = ()=>{
      const el = document.getElementById('weekStart'); let d = new Date(el.value || getWeekStartFor(new Date())); d.setDate(d.getDate()-7); el.value = d.toISOString().split('T')[0]; document.getElementById('weekLoad').click();
    }

    document.getElementById('clearAll').onclick = async ()=>{
      if(!confirm('هل أنت متأكد؟ سيتم حذف كل الحجوزات نهائياً')) return;
      try{
        const r = await fetch('/api/bookings/all', { method: 'DELETE', credentials: 'same-origin' });
        const data = await r.json();
        if(r.ok){ alert('تم حذف جميع الحجوزات'); loadBookings(); const wkStart=document.getElementById('weekStart').value; if(wkStart) document.getElementById('weekLoad').click(); }
        else alert('فشل: '+(data.error||'غير متوقع'));
      }catch(e){ alert('فشل الاتصال'); }
    }
    document.getElementById('weekNext').onclick = ()=>{
      const el = document.getElementById('weekStart'); let d = new Date(el.value || getWeekStartFor(new Date())); d.setDate(d.getDate()+7); el.value = d.toISOString().split('T')[0]; document.getElementById('weekLoad').click();
    }

    function renderWeekView(startDate, bookings){
      const start = new Date(startDate);
      const days = Array.from({length:7},(_,i)=>{ const dd=new Date(start); dd.setDate(start.getDate()+i); return dd; });
      const container = document.getElementById('weekView'); container.innerHTML='';

      // prepare timeslots (30-min steps) — extend to 23:30 and include midnight 00:00
      const times = [];
      for(let h=8; h<=23; h++){ times.push(`${String(h).padStart(2,'0')}:00`); times.push(`${String(h).padStart(2,'0')}:30`); }
      // add 00:00 as final slot for the day
      times.push('00:00');


      // map bookings per day and fill slot arrays with booking objects or null
      const dayMap = {};
      days.forEach(d=>{ const key = d.toISOString().split('T')[0]; dayMap[key] = new Array(times.length).fill(null); });
      bookings.forEach(b => {
        const key = b.date; if(!dayMap[key]) return; const idx = times.indexOf(b.time); if(idx<0) return; const span = Math.max(1, Math.ceil(b.duration/30));
        dayMap[key][idx] = Object.assign({}, b, {span});
        for(let k=1;k<span;k++){ dayMap[key][idx+k] = 'skip'; }
      });

      // build table
      const table = document.createElement('table'); table.className = 'timetable-table';
      const thead = table.createTHead(); const hr = thead.insertRow();
      hr.insertCell().outerHTML = '<th class="time-head">الوقت</th>'; // first column = time (appears on the right in RTL)
      days.forEach(d=>{ const th = document.createElement('th'); th.textContent = d.toLocaleDateString('ar-EG',{weekday:'short'}) + '\n' + d.toISOString().split('T')[0]; hr.appendChild(th); });

      const tbody = table.createTBody();
      for(let i=0;i<times.length;i++){
        const tr = tbody.insertRow();
        const timeCell = tr.insertCell(); timeCell.className = 'time'; timeCell.textContent = times[i];
        days.forEach(d=>{
          const key = d.toISOString().split('T')[0];
          const cell = dayMap[key][i];
          if(cell === 'skip') return; // cell covered by rowspan
          if(cell === null){
            const td = tr.insertCell();
            td.className = 'free-cell empty';
            td.textContent = '-';
            td.onclick = ()=>{ openAddModal(key, times[i]); };
          } else {
            const td = tr.insertCell();
            td.className = 'booked-cell';
            td.rowSpan = cell.span;
            td.innerHTML = `<div style="font-weight:700">${cell.name}</div><div style="font-size:0.85rem;margin-top:6px">${cell.time} · ${cell.duration} د</div>`;
            td.dataset.id = cell.id;
            td.onclick = ()=> openModal(cell);
          }
        });
      }

      const title = document.createElement('div'); title.style.fontWeight='700'; title.style.marginBottom='8px'; title.textContent = 'الجدول الأسبوعي — ' + start.toLocaleDateString('ar-EG') + ' → ' + new Date(new Date(start).setDate(start.getDate()+6)).toLocaleDateString('ar-EG');
      container.appendChild(title);
      const wrap = document.createElement('div'); wrap.style.overflow='auto'; wrap.appendChild(table); container.appendChild(wrap);
    }

    // نافذة التفاصيل
    const modal = document.getElementById('detailModal');
    function openModal(b){
      document.getElementById('modalContent').innerHTML = `<div><b>${b.name}</b> — ${b.phone}</div><div>التاريخ: ${b.date}</div><div>الوقت: ${b.time}</div><div>المدة: ${b.duration} دقيقة</div><div>السعر: ${b.price} دينار</div>`;
      modal.style.display = 'block';
      modal.dataset.currentId = b.id;
    }
    document.getElementById('modalClose').onclick = ()=>{ modal.style.display='none'; modal.dataset.currentId=''; };
    document.getElementById('modalCancel').onclick = async ()=>{
      if(!confirm('هل تريد إلغاء الحجز؟')) return;
      const id = modal.dataset.currentId;
      const r = await fetch('/api/bookings/'+id, { method:'DELETE', credentials: 'same-origin' });
      if(r.ok){ alert('تم الإلغاء'); modal.style.display='none'; loadBookings(); const wkStart=document.getElementById('weekStart').value; if(wkStart) document.getElementById('weekLoad').click(); }
      else alert('فشل الحذف');
    }

    // فتح نافذة إضافة الحجز المنبثقة مسبقاً مع تعبئة الحقول
    function openAddModal(date, time){
      document.getElementById('addDate').value = date;
      document.getElementById('addTime').value = time;
      document.getElementById('addDur').value = '60';
      document.getElementById('addPrice').value = staticPromos['60'] || '';
      document.getElementById('addName').value = '';
      document.getElementById('addPhone').value = '';
      document.getElementById('addModal').style.display = 'block';
    }

    document.getElementById('addClose').onclick = ()=>{ document.getElementById('addModal').style.display = 'none'; };
    document.getElementById('addDur').onchange = function(){ document.getElementById('addPrice').value = staticPromos[this.value] || ''; };

    document.getElementById('addSave').onclick = async ()=>{
      const name = document.getElementById('addName').value.trim();
      const cc = document.getElementById('addCountry').value || '+973';
      let phoneRaw = document.getElementById('addPhone').value.trim();
      let digits = phoneRaw.replace(/\D/g,'');
      if(!digits) return alert('ادخل رقم هاتف صحيح');
      let phone = digits.startsWith('0') ? cc + digits.replace(/^0+/, '') : (digits.startsWith('+') ? digits : cc + digits);
      const date = document.getElementById('addDate').value;
      const time = document.getElementById('addTime').value;
      const duration = Number(document.getElementById('addDur').value);
      const price = Number(document.getElementById('addPrice').value) || 0;
      if(!name || !phone || !date || !time || !duration) return alert('اكمل الحقول المطلوبة');
      try{
        const res = await postJson('/api/bookings',{name,phone,date,time,duration,price});
        if(res && res.error) { if(res.error==='conflict') alert('هذا الوقت محجوز'); else alert('فشل: '+res.error); }
        else { alert('تم الإضافة'); document.getElementById('addModal').style.display='none'; loadBookings(); const wkStart=document.getElementById('weekStart').value; if(wkStart) document.getElementById('weekLoad').click(); }
      }catch(e){ alert('فشل الاتصال'); }
    }

    // تعديل التعامل مع الصفوف لفتح نافذة التفاصيل بدلاً من الحذف المباشر
    document.getElementById('chgPwd').onclick = async ()=>{
      const oldPwd=document.getElementById('oldPwd').value; const newPwd=document.getElementById('newPwd').value;
      const res = await postJson('/api/admin/change-password',{oldPassword:oldPwd,newPassword:newPwd});
      if(res.ok) alert('تم التغيير'); else alert('فشل: '+(res.error||'غير متوقع'));
    }



    // ensure promotions are loaded after login
    async function postLoginInit(){
      setCurrentWeekAndLoad();
      startWeekWatcher();
      try{
        if(window.eventS && window.eventS.close) window.eventS.close();
        window.eventS = new EventSource('/api/events');
        window.eventS.addEventListener('booking-created', e => { const b = JSON.parse(e.data); onBookingCreated(b); });
        window.eventS.addEventListener('booking-deleted', e => { const d = JSON.parse(e.data); onBookingDeleted(d); });
        window.eventS.addEventListener('bookings-cleared', e => { document.querySelector('#bookingsTable tbody').innerHTML=''; document.getElementById('weekLoad').click(); });
        window.eventS.onerror = (err)=>{ console.error('SSE error', err); };
      }catch(e){ console.error('EventSource init failed', e); }
    }

    // modify login click handler to call postLoginInit instead of inline
    const oldLogin = document.getElementById('loginBtn').onclick;
    document.getElementById('loginBtn').onclick = async function(e){
      const pwd = document.getElementById('adminPwd').value;
      try{
        const res = await postJson('/api/admin/login',{password:pwd});
        if(res && res.ok){ document.getElementById('loginCard').style.display='none'; document.getElementById('adminUI').style.display='block'; loadBookings(); await postLoginInit(); }
        else { document.getElementById('loginMsg').textContent = res && res.error ? ('خطأ: '+res.error) : 'كلمة مرور خاطئة'; }
      }catch(err){
        console.error('login error', err);
        document.getElementById('loginMsg').textContent = 'فشل الاتصال بالخادم. تأكد أن السيرفر يعمل (npm start) وفتح الصفحة عبر http://localhost:3000/admin.html';
      }
    }

    // بعد تحميل الحجوزات، ربط زر التفاصيل
    const originalLoad = loadBookings;
    async function loadBookings(){
      // إعادة استخدام الكود السابق مع تعديل الزر
      const from = document.getElementById('fromDate').value || '';
      const to = document.getElementById('toDate').value || '';
      const q = (from && to) ? `?from=${from}&to=${to}` : '';
      const res = await fetch('/api/bookings' + q);
      if(res.status===401){ alert('غير مصرح'); return; }
      const rows = await res.json();
      const tbody = document.querySelector('#bookingsTable tbody'); tbody.innerHTML='';
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.name}</td><td>${r.phone}</td><td>${r.date}</td><td>${r.time}</td><td>${r.duration}</td><td>${r.price}</td><td><button data-id="${r.id}" class="details">تفاصيل</button></td>`;
        tbody.appendChild(tr);
      });
      document.querySelectorAll('.details').forEach(b=>{ b.onclick = ()=>{ const id=b.dataset.id; const row = rows.find(x=>x.id==id); openModal(row); }; });
    }

    // إعادة تعيين تحميل الحجوزات للزر
    document.getElementById('loadBtn').onclick = loadBookings;

    // Handle real-time booking created (insert into table and refresh week view if needed)
    function onBookingCreated(b){
      try{
        const tbody = document.querySelector('#bookingsTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${b.name}</td><td>${b.phone}</td><td>${b.date}</td><td>${b.time}</td><td>${b.duration}</td><td>${b.price}</td><td><button data-id="${b.id}" class="details">تفاصيل</button></td>`;
        tbody.insertBefore(tr, tbody.firstChild);
        tr.querySelector('.details').onclick = ()=>{ openModal(b); };
        // If currently viewing week that includes this booking, refresh week view
        const wkStart = document.getElementById('weekStart').value;
        if(wkStart){ const wkStartDate = new Date(wkStart); const wkEndDate = new Date(new Date(wkStartDate).setDate(wkStartDate.getDate()+6)); const bd = new Date(b.date); if(bd>=wkStartDate && bd<=wkEndDate) document.getElementById('weekLoad').click(); }
      }catch(e){ console.error('onBookingCreated error', e); }
    }

    // Handle real-time booking deletion (remove from table and refresh week view if needed)
    function onBookingDeleted(d){
      try{
        const tbody = document.querySelector('#bookingsTable tbody');
        const btn = tbody.querySelector(`button[data-id='${d.id}']`);
        if(btn) btn.closest('tr').remove();
        const wkStart = document.getElementById('weekStart').value;
        if(wkStart && d.date){ const wkStartDate = new Date(wkStart); const wkEndDate = new Date(new Date(wkStartDate).setDate(wkStartDate.getDate()+6)); const bd = new Date(d.date); if(bd>=wkStartDate && bd<=wkEndDate) document.getElementById('weekLoad').click(); }
      }catch(e){ console.error('onBookingDeleted error', e); }
    }
  </script>
</body>
</html>